<!-- address-management.component.html -->
<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title class="header-title">收货地址</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="content-area">
  @if (addresses().length > 0) {
    <ion-list lines="none" class="address-list">
      @for (address of addresses(); track address.id) {
        <ion-item
          class="address-card"
          [class.default]="address.isDefault"
          (click)="editAddress(address)">
          <div class="address-info">
            <div class="recipient-info">
              <span class="name">{{ address.name }}</span>
              <span class="phone">{{ address.phone }}</span>
              @if (address.isDefault) {
                <ion-badge class="default-tag" color="primary">默认</ion-badge>
              }
            </div>
            <div class="full-address">
              {{ address.province }}{{ address.city }}{{ address.district }}{{ address.detail }}
            </div>
          </div>
          <div class="actions">
            <ion-button fill="clear" class="edit-btn" (click)="editAddress(address); $event.stopPropagation()">
              <ion-icon slot="icon-only" name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" class="delete-btn" (click)="deleteAddress(address.id); $event.stopPropagation()">
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      }
    </ion-list>
  } @else {
    <div class="empty-state">
      <ion-icon name="location-outline" class="empty-icon"></ion-icon>
      <p>您还未添加收货地址</p>
    </div>
  }
</ion-content>

<ion-footer class="ion-no-border">
  <ion-toolbar>
    <ion-button
      expand="block"
      class="add-button"
      (click)="openAddModal()">
      <ion-icon slot="start" name="add-outline"></ion-icon>
      新增收货地址
    </ion-button>
  </ion-toolbar>
</ion-footer>

<ion-modal
  [isOpen]="showModal()"
  (ionModalDidDismiss)="closeModal()"
  trigger="open-modal"
  class="custom-modal">
  <ng-template>
    <ion-header class="ion-no-border">
      <ion-toolbar>
        <ion-title class="modal-title">
          {{ isEditing() ? '编辑地址' : '新增地址' }}
        </ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModal()">
            <ion-icon slot="icon-only" name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="form-content" style="height: 80vh" scrollY="true">
      <form #addressForm="ngForm" class="address-form">
        <ion-item>
          <ion-label position="stacked">收货人</ion-label>
          <ion-input
            type="text"
            placeholder="请输入收货人姓名"
            [(ngModel)]="currentAddress().name"
            name="name"
            required></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">手机号码</ion-label>
          <ion-input
            type="tel"
            placeholder="请输入手机号码"
            [(ngModel)]="currentAddress().phone"
            name="phone"
            pattern="1[0-9]{10}"
            required></ion-input>
        </ion-item>

        <!-- 省份选择 -->
        <ion-item class="form-group">
          <ion-label position="stacked">省份</ion-label>
          <ion-button
            fill="clear"
            class="picker-button"
            (click)="openProvincePicker()"
            [disabled]="provinces.length === 0">
            <span *ngIf="selectedProvince; else noProvince">{{ selectedProvince }}</span>
            <ng-template #noProvince>
              <span class="placeholder">请选择省份</span>
            </ng-template>
            <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
          </ion-button>
        </ion-item>

        <!-- 城市选择 -->
        <ion-item class="form-group">
          <ion-label position="stacked">城市</ion-label>
          <ion-button
            fill="clear"
            class="picker-button"
            (click)="openCityPicker()"
            [disabled]="!selectedProvince || getFilteredCities().length === 0">
            <span *ngIf="selectedCity; else noCity">{{ selectedCity }}</span>
            <ng-template #noCity>
              <span class="placeholder">请选择城市</span>
            </ng-template>
            <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
          </ion-button>
        </ion-item>

        <!-- 区县选择 -->
        <ion-item class="form-group">
          <ion-label position="stacked">区/县</ion-label>
          <ion-button
            fill="clear"
            class="picker-button"
            (click)="openDistrictPicker()"
            [disabled]="!selectedCity || getFilteredDistricts().length === 0">
            <span *ngIf="selectedDistrict; else noDistrict">{{ selectedDistrict }}</span>
            <ng-template #noDistrict>
              <span class="placeholder">请选择区/县</span>
            </ng-template>
            <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">详细地址</ion-label>
          <ion-textarea
            placeholder="街道、小区、楼号等"
            [(ngModel)]="currentAddress().detail"
            name="detail"
            required
            rows="2"></ion-textarea>
        </ion-item>

        <ion-item lines="none">
          <ion-checkbox
            slot="start"
            [(ngModel)]="currentAddress().isDefault"
            name="isDefault"></ion-checkbox>
          <ion-label>设为默认地址</ion-label>
        </ion-item>
      </form>
    </ion-content>

    <ion-footer class="ion-no-border">
      <ion-toolbar>
        <ion-button
          expand="block"
          class="save-btn"
          (click)="saveAddress()"
          [disabled]="!currentAddress().name || !currentAddress().phone || !currentAddress().detail || !selectedProvince || !selectedCity || !selectedDistrict">
          {{ isEditing() ? '保存地址' : '添加地址' }}
        </ion-button>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>

<!-- 省份选择模态框 -->
<ion-modal #provinceModal>
  <ng-template>
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button (click)="cancelProvince()">取消</ion-button>
      </ion-buttons>
      <ion-title>选择省份</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="confirmProvince()">确定</ion-button>
      </ion-buttons>
    </ion-toolbar>
    <ion-picker>
      <ion-picker-column [value]="provincePickerValue" (ionChange)="onProvinceChange($event)">
        <ion-picker-column-option *ngFor="let province of provinces" [value]="province">
          {{ province }}
        </ion-picker-column-option>
      </ion-picker-column>
    </ion-picker>
  </ng-template>
</ion-modal>

<!-- 城市选择模态框 -->
<ion-modal #cityModal>
  <ng-template>
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button (click)="cancelCity()">取消</ion-button>
      </ion-buttons>
      <ion-title>选择城市</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="confirmCity()">确定</ion-button>
      </ion-buttons>
    </ion-toolbar>
    <ion-picker>
      <ion-picker-column [value]="cityPickerValue" (ionChange)="onCityChange($event)">
        <ion-picker-column-option *ngFor="let city of getFilteredCities()" [value]="city">
          {{ city }}
        </ion-picker-column-option>
      </ion-picker-column>
    </ion-picker>
  </ng-template>
</ion-modal>

<!-- 区县选择模态框 -->
<ion-modal #districtModal>
  <ng-template>
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button (click)="cancelDistrict()">取消</ion-button>
      </ion-buttons>
      <ion-title>选择区/县</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="confirmDistrict()">确定</ion-button>
      </ion-buttons>
    </ion-toolbar>
    <ion-picker>
      <ion-picker-column [value]="districtPickerValue" (ionChange)="onDistrictChange($event)">
        <ion-picker-column-option *ngFor="let district of getFilteredDistricts()" [value]="district">
          {{ district }}
        </ion-picker-column-option>
      </ion-picker-column>
    </ion-picker>
  </ng-template>
</ion-modal>
