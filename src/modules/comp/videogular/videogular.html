<!-- videogular.component.html -->
<div class="video-container" [class.theater-mode]="isTheaterMode" [class.widescreen]="isWidescreen"
  (mousemove)="handleMouseMove($event)" (mouseleave)="hideControls=true" (contextmenu)="menu($event)">
  <!-- 关灯模式蒙层 -->
  <div class="dark-overlay" *ngIf="isTheaterMode"></div>

  <vg-player (onPlayerReady)="onPlayerReady($event)" #mediaPlayer tabindex="0" (keydown)="handleKeyEvents($event)"
    [class.hide-controls]="hideControls">
    <!-- 视频主体 -->
    <video [vgMedia]="$any(media)" #media id="mainVideo" preload="auto" crossorigin="anonymous" autoplay muted
      playsinline [poster]="posterImage" (canplay)="onCanPlay($event)"
      (error)="onVideoError($event)" (stalled)="onStalled($event)" (progress)="onProgress($event)"
      (waiting)="onWaiting($event)" (playing)="onPlaying($event)">
      <!-- 仅保留一个source元素用于HLS -->
      <source [src]="currentHlsUrl" type="application/x-mpegURL">
    </video>

    <!-- 播放器覆盖层 -->
    <vg-overlay-play *ngIf="showOverlayPlay" (click)="togglePlayback()"></vg-overlay-play>

    <!-- 自定义缓冲指示器 -->
    <div class="custom-buffering" *ngIf="isBuffering">
      <div class="spinner"></div>
      <div class="buffering-text">加载中...</div>
    </div>

    <!-- 加载失败提示 -->
    <div class="load-error" *ngIf="loadError">
      <div class="error-icon">❌</div>
      <div class="error-text">视频加载失败</div>
      <button class="retry-button" (click)="retryLoading()">重试</button>
    </div>

    <!-- 播放器控制界面 -->
    <vg-controls>
      <!-- 顶部进度条 -->
      <vg-scrub-bar class="top-scrub-bar" #scrubBar (mousedown)="startScrubbing($event)">
        <vg-scrub-bar-current-time></vg-scrub-bar-current-time>
      </vg-scrub-bar>

      <!-- 控制栏主体 -->
      <div class="controls-container">
        <!-- 左侧控制组 -->
        <div class="left-controls">
          <!-- 播放/暂停按钮 -->
          <vg-play-pause></vg-play-pause>

          <!-- 下一个按钮 -->
          <button class="next-button" (click)="nextVideo()" title="下一个">
            <i>⏭️</i>
          </button>

          <!-- 时间显示 -->
          <div class="time-display">
            <vg-time-display vgProperty="current" vgFormat="mm:ss"></vg-time-display>
            <span>/</span>
            <vg-time-display vgProperty="total" vgFormat="mm:ss"></vg-time-display>
          </div>
        </div>

        <!-- 右侧控制组 -->
        <div class="right-controls">
          <!-- 清晰度控制 -->
          <div class="quality-control" (mouseenter)="onControlEnter('quality')"
            (mouseleave)="onControlLeave('quality')">
            <div class="quality-trigger">{{ selectedQuality.label }}</div>
            <div class="quality-dropdown" *ngIf="showQualityOptions" [class.upward]="true">
              <ul>
                <li *ngFor="let quality of availableQualities" (click)="selectQuality(quality)"
                  [class.active]="quality.url === selectedQuality.url">
                  {{ quality.label }}
                </li>
              </ul>
            </div>
          </div>

          <!-- 倍速控制 -->
          <div class="speed-control" (mouseenter)="onControlEnter('speed')" (mouseleave)="onControlLeave('speed')">
            <div class="speed-trigger">{{ getSpeedLabel() }}</div>
            <div class="speed-dropdown" *ngIf="showSpeedOptions" [class.upward]="true">
              <ul>
                <li *ngFor="let speed of speedOptions" (click)="selectSpeed(speed.value)"
                  [class.active]="speed.value === playbackRate">
                  {{ speed.label }}
                </li>
              </ul>
            </div>
          </div>

          <!-- 音量控制 -->
          <div class="volume-control" (mouseenter)="onControlEnter('volume')" (mouseleave)="onControlLeave('volume')">
            <button (click)="toggleMute()" class="volume-button">
              <i *ngIf="!isMuted" class="volume-icon">🔊</i>
              <i *ngIf="isMuted" class="volume-icon">🔇</i>
            </button>
            <div class="volume-slider-vertical" *ngIf="showVolumeSlider">
              <input type="range" min="0" max="1" step="0.05" [(ngModel)]="volume" (input)="setVolume($event)"
                class="volume-slider-vertical-input">
            </div>
          </div>

          <!-- 设置按钮 -->
          <div class="s-c">
            <button class="s-b" title="设置">
              <i>⚙️</i>
            </button>
            <div class="s-d">
              <!-- 设置菜单标题 -->
              <div class="s-h">
                <h4>播放设置</h4>
              </div>
              
              <!-- 设置选项组 -->
              <div class="s-g">
                <h5>视图模式</h5>
                <div class="s-grid">
                  <button (click)="toggleWidescreen()" [class.active]="isWidescreen" title="宽屏模式">
                    <i class="s-i">🖥️</i>
                    <span>宽屏模式</span>
                  </button>
                  <button (click)="toggleWebFullscreen()" [class.active]="isWebFullscreen" title="网页全屏">
                    <i class="s-i">📱</i>
                    <span>网页全屏</span>
                  </button>
                  <button (click)="toggleTheaterMode()" [class.active]="isTheaterMode" title="关灯模式">
                    <i class="s-i">🌙</i>
                    <span>关灯模式</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 全屏模式 -->
          <vg-fullscreen (click)="enterFullscreen()"></vg-fullscreen>
        </div>
      </div>
    </vg-controls>
  </vg-player>

  <!-- 键盘快捷键提示 -->
  <div class="keyboard-hint">
    <span>空格:播放/暂停</span>
    <span>←→:快进/快退</span>
    <span>↑↓:音量调节</span>
    <span>1-9:跳转进度</span>
  </div>
</div>